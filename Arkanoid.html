<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Arkanoid Deluxe ‚Äî Neon</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#071226; --bg2:#07182a; --neon1:#66fcf1; --neon2:#9b7bff; --accent:#ffb86c; --panel: rgba(255,255,255,0.04);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:radial-gradient(circle at 10% 10%, #081228 0%, #071022 40%, #030416 100%);color:#fff;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden;}
.app{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;}
.game-wrapper{width:100%;max-width:900px;height:min(92vh,920px);border-radius:16px;overflow:hidden;position:relative;background: linear-gradient(180deg, rgba(4,8,20,0.45), rgba(2,4,12,0.7));box-shadow: 0 30px 80px rgba(2,6,23,0.75), inset 0 1px 0 rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03);}
canvas{display:block;width:100%;height:100%;touch-action:none;background:linear-gradient(180deg, rgba(0,0,0,0.2), rgba(0,0,0,0.4));}
.hud{position:absolute;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;pointer-events:none;gap:8px;}
.hud .group{background: rgba(0,0,0,0.35);padding:8px 12px;border-radius:12px;display:flex;gap:10px;align-items:center;font-weight:600;font-size:0.95rem;pointer-events:auto;backdrop-filter: blur(4px);}
.hud .center{justify-content:center;align-items:center}
.overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.panel{pointer-events:auto;background:linear-gradient(180deg, rgba(2,6,20,0.7), rgba(4,8,20,0.55));border-radius:14px;padding:20px;width:min(92%,460px);text-align:center;box-shadow:0 12px 30px rgba(0,0,0,0.6);border:1px solid var(--panel)}
h1{margin:0 0 10px 0;font-size:1.9rem;background:linear-gradient(90deg,var(--neon1),var(--neon2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
p.lead{margin:8px 0 12px;color:rgba(255,255,255,0.9);line-height:1.4}
.controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px}
.btn{background:linear-gradient(90deg,var(--neon1),var(--neon2));border:none;padding:10px 14px;border-radius:10px;color:#021;cursor:pointer;font-weight:700;box-shadow:0 8px 20px rgba(109,84,255,0.12)}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.9);box-shadow:none}
.popup{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(92%,420px);background:linear-gradient(180deg,rgba(0,0,0,0.88),rgba(0,0,0,0.72));border-radius:14px;padding:18px;display:none;pointer-events:auto;border:1px solid var(--panel)}
.popup.show{display:block;animation:pop .18s ease-out}
@keyframes pop{from{transform:translate(-50%,-50%) scale(.96);opacity:0}to{transform:translate(-50%,-50%) scale(1);opacity:1}}
.power-ind{position:absolute;left:50%;transform:translateX(-50%);bottom:18px;padding:8px 12px;border-radius:16px;background:rgba(0,0,0,0.46);display:none;font-weight:700}
.touch-hint{font-size:0.9rem;color:rgba(255,255,255,0.8);margin-top:8px}
.mobile-controls{position:absolute;bottom:20px;width:100%;display:flex;justify-content:space-between;padding:0 20px;display:none;}
.mobile-controls .arrow{width:50px;height:50px;background:rgba(102,252,241,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;color:var(--neon1);border:2px solid rgba(102,252,241,0.4);}
@media (max-width:520px){
  h1{font-size:1.4rem}
  .hud .group{font-size:0.86rem;padding:6px 10px}
  .btn{padding:10px 12px}
  .mobile-controls{display:flex;}
}
</style>
</head>
<body>
<div class="app">
  <div class="game-wrapper" id="gameWrapper" role="application" aria-label="Arkanoid Deluxe">
    <canvas id="c" aria-hidden="false"></canvas>

    <div class="hud" aria-hidden="false">
      <div class="group left" id="leftHud">
        <div id="score">Puntos: 0</div>
        <div id="lives" style="opacity:0.9">Vidas: 3</div>
      </div>
      <div class="group center"><div id="level">Nivel: 1</div></div>
      <div class="group right" style="justify-self:end">
        <button id="soundBtn" class="btn ghost" title="Silenciar/Activar sonido">üîä</button>
        <button id="helpBtn" class="btn ghost">?</button>
      </div>
    </div>

    <div class="mobile-controls" id="mobileControls">
      <div class="arrow left-arrow" id="leftArrow">‚Üê</div>
      <div class="arrow right-arrow" id="rightArrow">‚Üí</div>
    </div>

    <div class="power-ind" id="powerInd"></div>

    <div class="overlay" id="startOverlay">
      <div class="panel" role="dialog" aria-label="Pantalla de inicio">
        <h1>üéÆ Arkanoid Deluxe</h1>
        <p class="lead">Mueve la paleta con ‚¨ÖÔ∏è ‚û°Ô∏è, tocando/arrastrando o con el mouse. Rebota la bola y destruye todos los bloques. ¬°Recoge power-ups!</p>
        <div class="controls">
          <button id="startBtn" class="btn">Comenzar</button>
          <button id="levelSelectBtn" class="btn ghost">Nivel 1</button>
        </div>
        <p class="touch-hint">M√∫sica synthwave generada en tiempo real ‚Ä¢ Sin archivos externos</p>
      </div>
    </div>

    <div class="popup" id="gameOver">
      <h2 style="margin:6px 0 8px">üíÄ Fin del juego</h2>
      <p id="finalScore">Puntuaci√≥n final: 0</p>
      <div style="margin-top:12px" class="controls">
        <button id="restartBtn" class="btn">Jugar de nuevo</button>
        <button id="toMenuBtn" class="btn ghost">Men√∫</button>
      </div>
    </div>

    <div class="popup" id="levelComplete">
      <h2 style="margin:6px 0 8px">üéâ Nivel completado</h2>
      <p id="levelScore">Puntos del nivel: 0</p>
      <div style="margin-top:12px" class="controls">
        <button id="nextLevelBtn" class="btn">Siguiente nivel</button>
        <button id="menu2Btn" class="btn ghost">Men√∫</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------ Variables Globales ------------------ */
const wrapper = document.getElementById('gameWrapper');
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha: true });
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const scoreEl = document.getElementById('score');
const livesEl = document.getElementById('lives');
const levelEl = document.getElementById('level');
const powerInd = document.getElementById('powerInd');
const gameOverPopup = document.getElementById('gameOver');
const levelCompletePopup = document.getElementById('levelComplete');
const finalScoreEl = document.getElementById('finalScore');
const levelScoreEl = document.getElementById('levelScore');
const restartBtn = document.getElementById('restartBtn');
const nextLevelBtn = document.getElementById('nextLevelBtn');
const toMenuBtn = document.getElementById('toMenuBtn');
const menu2Btn = document.getElementById('menu2Btn');
const soundBtn = document.getElementById('soundBtn');
const helpBtn = document.getElementById('helpBtn');
const leftArrow = document.getElementById('leftArrow');
const rightArrow = document.getElementById('rightArrow');
const mobileControls = document.getElementById('mobileControls');

let audioActive = true;
let score=0,lives=3,level=1,bricks=[],balls=[],paddle=null,brickCfg=null,particles=[],powerUps=[],activePowerUps={},powerUpTimer=0;
let gameOver=false,levelComplete=false,running=false;
let audioCtx=null,masterGain=null,bgGain=null,bgOscs=[],bgLfo=null,bgScheduler=null;
let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

/* ------------------ Canvas responsivo ------------------ */
function resizeCanvasToDisplaySize(){
  const rect = wrapper.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const width = Math.max(320, Math.round(rect.width));
  const height = Math.max(420, Math.round(rect.height));
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  canvas.width = Math.floor(width * dpr);
  canvas.height = Math.floor(height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

/* ------------------ Audio ------------------ */
function ensureAudio(){ if(!audioCtx){ audioCtx=new(window.AudioContext||window.webkitAudioContext)(); masterGain=audioCtx.createGain(); masterGain.gain.value=0.9; bgGain=audioCtx.createGain(); bgGain.gain.value=0.06; masterGain.connect(audioCtx.destination); bgGain.connect(masterGain);}}
function resumeAudio(){ ensureAudio(); if(audioCtx.state==='suspended') audioCtx.resume(); if(!bgScheduler) startBackground();}
function suspendAudio(){ if(audioCtx) audioCtx.suspend(); }
soundBtn.addEventListener('click',()=>{ audioActive=!audioActive; soundBtn.textContent=audioActive?'üîä':'üîà'; audioActive?resumeAudio():suspendAudio();});

/* ------------------ Background synth ------------------ */
function startBackground(){
  if(!audioCtx) return;
  if(bgScheduler){ clearInterval(bgScheduler); bgScheduler=null; }
  const oscA=audioCtx.createOscillator(), oscB=audioCtx.createOscillator(), filter=audioCtx.createBiquadFilter();
  filter.type='lowpass'; filter.frequency.value=900;
  oscA.type='sine'; oscB.type='sine';
  const gA=audioCtx.createGain(); gA.gain.value=0.6;
  const gB=audioCtx.createGain(); gB.gain.value=0.35;
  oscA.connect(gA); gA.connect(filter); oscB.connect(gB); gB.connect(filter);
  filter.connect(bgGain);
  const lfo=audioCtx.createOscillator(); lfo.frequency.value=0.06; const lfoGain=audioCtx.createGain(); lfoGain.gain.value=260; lfo.connect(lfoGain); lfoGain.connect(filter.frequency);
  oscA.start(); oscB.start(); lfo.start();
  bgOscs=[oscA,oscB]; bgLfo=lfo;
  let idx=0; const chords=[0,3,5,7]; const base=110; const semitone=Math.pow(2,1/12);
  bgScheduler=setInterval(()=>{ if(!audioActive) return; const offset=chords[idx%chords.length]; const f1=base*Math.pow(semitone,offset); const f2=f1*2; try{oscA.frequency.linearRampToValueAtTime(f1,audioCtx.currentTime+0.5); oscB.frequency.linearRampToValueAtTime(f2,audioCtx.currentTime+0.5);}catch(e){}; idx++;},1600);
}

/* ------------------ SFX ------------------ */
function sfx(type){
  if(!audioCtx||!audioActive) return;
  const now=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain(), f=audioCtx.createBiquadFilter();
  if(type==='bounce'){ o.type='square'; o.frequency.setValueAtTime(600,now); g.gain.setValueAtTime(0.001,now); g.gain.exponentialRampToValueAtTime(0.12,now+0.004); g.gain.exponentialRampToValueAtTime(0.001,now+0.12); f.type='highpass'; f.frequency.value=300;}
  else if(type==='break'){ o.type='sawtooth'; o.frequency.setValueAtTime(200,now); o.frequency.exponentialRampToValueAtTime(900,now+0.14); g.gain.setValueAtTime(0.12,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.22); f.type='lowpass'; f.frequency.value=1200;}
  else if(type==='power'){ o.type='triangle'; o.frequency.setValueAtTime(900,now); g.gain.setValueAtTime(0.08,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.28); f.type='lowpass'; f.frequency.value=1800;}
  else if(type==='gameover'){ o.type='sine'; o.frequency.setValueAtTime(220,now); o.frequency.exponentialRampToValueAtTime(60,now+0.8); g.gain.setValueAtTime(0.15,now); g.gain.exponentialRampToValueAtTime(0.001,now+0.9); f.type='lowpass'; f.frequency.value=800;}
  o.connect(f); f.connect(g); g.connect(masterGain); o.start(now); o.stop(now+1.1);
}

/* ------------------ Game Defaults ------------------ */
function makeDefaults(){
  score=0; lives=3; level=1; particles=[]; powerUps=[]; activePowerUps={}; powerUpTimer=0; bricks=[]; balls=[]; gameOver=false; levelComplete=false;
  const W = canvas.width/(window.devicePixelRatio||1), H = canvas.height/(window.devicePixelRatio||1);
  const pWidth=Math.min(150,Math.max(64,Math.round(W*0.18)));
  paddle={w:pWidth,h:Math.max(10,Math.round(W*0.02)),x:W/2-pWidth/2,y:H-Math.max(46,Math.round(H*0.07)),dx:0,speed:Math.max(5,Math.round(W/140)),color:'#66fcf1',originalWidth:pWidth};
  const ballSize=Math.max(6,Math.round(W/70));
  balls=[{x:W/2,y:paddle.y-12,size:ballSize,speed:Math.max(3.5,W/240),dx:3*(Math.random()>0.5?1:-1),dy:-3,color:'#ffb86c',originalSpeed:Math.max(3.5,W/240)}];
  brickCfg={row:Math.min(7,Math.max(4,Math.round(W/70))),col:Math.min(10,Math.max(5,Math.round(W/60))),padding:8,offsetTop:Math.max(42,Math.round(H*0.07)),offsetLeft:16,colors:['#ff6b6b','#ffd56b','#ffeaa7','#76e7b2','#6fb3ff']};
  const totalPaddingX=(brickCfg.col-1)*brickCfg.padding+2*brickCfg.offsetLeft;
  brickCfg.w=Math.max(36,Math.floor((W-totalPaddingX)/brickCfg.col));
  brickCfg.h=Math.max(16,Math.round(brickCfg.w*0.38));
  createBricks(); updateHUD();
}

function createBricks(){
  bricks=[];
  for(let r=0;r<brickCfg.row;r++){
    bricks[r]=[];
    for(let c=0;c<brickCfg.col;c++){
      const x=c*(brickCfg.w+brickCfg.padding)+brickCfg.offsetLeft;
      const y=r*(brickCfg.h+brickCfg.padding)+brickCfg.offsetTop;
      const strength=r<2?1:r<4?2:3;
      bricks[r][c]={x,y,w:brickCfg.w,h:brickCfg.h,status:true,strength,originalStrength:strength};
    }
  }
}

/* ------------------ Loop & Draw ------------------ */
function draw(){
  const W=canvas.width/(window.devicePixelRatio||1), H=canvas.height/(window.devicePixelRatio||1);
  ctx.clearRect(0,0,W,H);
  const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'rgba(6,13,29,0.2)'); g.addColorStop(1,'rgba(3,6,18,0.25)'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  for(let i=0;i<40;i++){ const sx=(i*47+Math.floor(powerUpTimer/3))%W; const sy=(i*31+(i*7))%(H*0.5); const s=(Math.sin((i+powerUpTimer)*0.025)+1.3)*1.6; ctx.fillStyle='rgba(102,252,241,0.06)'; ctx.beginPath(); ctx.arc(sx,sy,s,0,2*Math.PI); ctx.fill(); ctx.closePath();}
  for(const row of bricks){for(const b of row){if(!b||!b.status) continue; ctx.fillStyle=b.strength===3?'#ff3b30':b.strength===2?'#ffb74d':'#66fcf1'; ctx.fillRect(b.x,b.y,b.w,b.h);}}
  ctx.fillStyle=paddle.color; ctx.fillRect(paddle.x,paddle.y,paddle.w,paddle.h);
  for(const b of balls){ctx.beginPath(); ctx.arc(b.x,b.y,b.size,0,Math.PI*2); ctx.fillStyle=b.color; ctx.fill(); ctx.closePath();}
  for(const p of powerUps){ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); ctx.closePath();}
  for(const p of particles){ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fillStyle=p.color; ctx.fill(); ctx.closePath();}
}

function update(){
  if(gameOver||levelComplete) return;
  movePaddle(); moveBalls(); movePowerUps(); moveParticles(); collisionDetection(); updateHUD();
}

function loop(){update(); draw(); requestAnimationFrame(loop);}

/* ------------------ Movimiento ------------------ */
function movePaddle(){
  const W=canvas.width/(window.devicePixelRatio||1);
  paddle.x+=paddle.dx;
  if(paddle.x<0)paddle.x=0;
  if(paddle.x+paddle.w>W)paddle.x=W-paddle.w;
}

function moveBalls(){
  const W=canvas.width/(window.devicePixelRatio||1), H=canvas.height/(window.devicePixelRatio||1);
  for(let i=balls.length-1;i>=0;i--){
    const b=balls[i];
    b.x+=b.dx; b.y+=b.dy;
    if(b.x-b.size<0){b.x=b.size+1;b.dx*=-1;sfx('bounce');} 
    if(b.x+b.size>W){b.x=W-b.size-1;b.dx*=-1;sfx('bounce');} 
    if(b.y-b.size<0){b.y=b.size+1;b.dy*=-1;sfx('bounce');} 
    if(b.x>paddle.x && b.x<paddle.x+paddle.w && b.y+b.size>paddle.y && b.y-b.size<paddle.y+paddle.h){const hitPos=(b.x-(paddle.x+paddle.w/2))/(paddle.w/2); b.dx=hitPos*(5+Math.abs(b.speed/1.2)); b.dy=-Math.abs(b.dy)||-Math.abs(b.speed); b.y=paddle.y-b.size-1; sfx('bounce');}
    if(b.y-b.size>H){balls.splice(i,1); if(balls.length===0){lives--; if(lives<=0){gameOver=true;sfx('gameover'); showGameOver();} else resetBall();}}}
}

function movePowerUps(){
  const H=canvas.height/(window.devicePixelRatio||1);
  for(let i=powerUps.length-1;i>=0;i--){
    const p=powerUps[i];
    p.y+=2;
    if(p.y>paddle.y && p.y<paddle.y+paddle.h && p.x>paddle.x && p.x<paddle.x+paddle.w){
      activatePowerUp(p);
      powerUps.splice(i,1);
    } else if(p.y>H){
      powerUps.splice(i,1);
    }
  }
}

function moveParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.dx;
    p.y+=p.dy;
    p.life--;
    if(p.life<=0){
      particles.splice(i,1);
    }
  }
}

function resetBall(){
  const W=canvas.width/(window.devicePixelRatio||1);
  const ballSize=Math.max(6,Math.round(W/70));
  balls=[{x:W/2,y:paddle.y-12,size:ballSize,speed:Math.max(3.5,W/240),dx:3*(Math.random()>0.5?1:-1),dy:-3,color:'#ffb86c',originalSpeed:Math.max(3.5,W/240)}];
  paddle.w=paddle.originalWidth;
}

/* ------------------ Colisiones ------------------ */
function collisionDetection(){
  for(const ball of balls){
    for(const row of bricks){
      for(const b of row){
        if(!b||!b.status) continue;
        if(ball.x>b.x && ball.x<b.x+b.w && ball.y>b.y && ball.y<b.y+b.h){
          const prevX=ball.x-ball.dx; if(prevX<b.x||prevX>b.x+b.w) ball.dx*=-1; else ball.dy*=-1;
          b.strength--; if(b.strength<=0){b.status=false; score+=10*b.originalStrength; sfx('break'); createParticles(b); maybePowerUp(b);}
          checkLevelComplete();
        }
      }
    }
  }
}

function createParticles(brick){
  for(let i=0;i<5;i++){
    particles.push({
      x: brick.x + brick.w/2,
      y: brick.y + brick.h/2,
      size: Math.random()*3+1,
      dx: (Math.random()-0.5)*4,
      dy: (Math.random()-0.5)*4,
      color: brick.strength===3?'#ff3b30':brick.strength===2?'#ffb74d':'#66fcf1',
      life: 30
    });
  }
}

function maybePowerUp(b){ 
  if(Math.random()<0.15){
    const types = ['expand', 'multiball', 'slow', 'laser'];
    const type = types[Math.floor(Math.random()*types.length)];
    let color = '#66fcf1';
    switch(type){
      case 'expand': color = '#66fcf1'; break;
      case 'multiball': color = '#ffb86c'; break;
      case 'slow': color = '#9b7bff'; break;
      case 'laser': color = '#ff6b6b'; break;
    }
    powerUps.push({x:b.x+b.w/2,y:b.y+b.h/2,size:8,type,color});
    sfx('power');
  }
}

function activatePowerUp(p){
  sfx('power');
  switch(p.type){
    case 'expand':
      paddle.w = Math.min(paddle.originalWidth*1.5, canvas.width/(window.devicePixelRatio||1)*0.3);
      setTimeout(() => { paddle.w = paddle.originalWidth; }, 10000);
      showPowerIndicator('Paleta expandida');
      break;
    case 'multiball':
      const newBalls = [];
      for(const ball of balls){
        newBalls.push({...ball, dx: -Math.abs(ball.dx), dy: ball.dy});
        newBalls.push({...ball, dx: Math.abs(ball.dx), dy: ball.dy});
      }
      balls.push(...newBalls);
      showPowerIndicator('Bolas m√∫ltiples');
      break;
    case 'slow':
      for(const ball of balls){
        ball.dx *= 0.7;
        ball.dy *= 0.7;
      }
      setTimeout(() => {
        for(const ball of balls){
          ball.dx /= 0.7;
          ball.dy /= 0.7;
        }
      }, 5000);
      showPowerIndicator('C√°mara lenta');
      break;
    case 'laser':
      // Implementar l√°ser en futuras versiones
      showPowerIndicator('L√°ser activado');
      break;
  }
}

function showPowerIndicator(text){
  powerInd.textContent = text;
  powerInd.style.display = 'block';
  setTimeout(() => {
    powerInd.style.display = 'none';
  }, 2000);
}

function checkLevelComplete(){if(bricks.flat().every(b=>!b.status)){levelComplete=true; showLevelComplete();}}

/* ------------------ HUD ------------------ */
function updateHUD(){scoreEl.textContent=`Puntos: ${score}`; livesEl.textContent=`Vidas: ${lives}`; levelEl.textContent=`Nivel: ${level}`;}

/* ------------------ UI ------------------ */
function showGameOver(){finalScoreEl.textContent=`Puntuaci√≥n final: ${score}`; gameOverPopup.classList.add('show');}
function hideGameOver(){gameOverPopup.classList.remove('show');}
function showLevelComplete(){levelScoreEl.textContent=`Puntos del nivel: ${score}`; levelCompletePopup.classList.add('show');}
function hideLevelComplete(){levelCompletePopup.classList.remove('show');}

/* ------------------ Controles ------------------ */
document.addEventListener('keydown',e=>{if(e.key==='ArrowLeft')paddle.dx=-paddle.speed;if(e.key==='ArrowRight')paddle.dx=paddle.speed;});
document.addEventListener('keyup',e=>{if(['ArrowLeft','ArrowRight'].includes(e.key))paddle.dx=0;});

// Controles t√°ctiles mejorados
let dragging=false;
canvas.addEventListener('touchstart',e=>{dragging=true; paddle.x=e.touches[0].clientX-wrapper.getBoundingClientRect().left-paddle.w/2;},{passive:false});
canvas.addEventListener('touchmove',e=>{if(dragging){e.preventDefault(); paddle.x=e.touches[0].clientX-wrapper.getBoundingClientRect().left-paddle.w/2;}},{passive:false});
canvas.addEventListener('touchend',()=>dragging=false);
canvas.addEventListener('mousedown',e=>{dragging=true;paddle.x=e.clientX-wrapper.getBoundingClientRect().left-paddle.w/2;});
window.addEventListener('mousemove',e=>{if(dragging)paddle.x=e.clientX-wrapper.getBoundingClientRect().left-paddle.w/2;});
window.addEventListener('mouseup',()=>dragging=false);

// Controles m√≥viles con botones
if(isMobile){
  leftArrow.addEventListener('touchstart',()=>{paddle.dx=-paddle.speed;});
  leftArrow.addEventListener('touchend',()=>{paddle.dx=0;});
  rightArrow.addEventListener('touchstart',()=>{paddle.dx=paddle.speed;});
  rightArrow.addEventListener('touchend',()=>{paddle.dx=0;});
}

/* ------------------ Botones ------------------ */
startBtn.addEventListener('click',()=>{startOverlay.style.display='none'; resumeAudio(); makeDefaults(); loop(); running=true;});
restartBtn.addEventListener('click',()=>{hideGameOver(); makeDefaults(); running=true; loop();});
nextLevelBtn.addEventListener('click',()=>{level++; hideLevelComplete(); makeDefaults(); running=true; loop();});
toMenuBtn.addEventListener('click',()=>{hideGameOver(); startOverlay.style.display='flex';});
menu2Btn.addEventListener('click',()=>{hideLevelComplete(); startOverlay.style.display='flex';});
helpBtn.addEventListener('click',()=>{alert('Flechas ‚Üê ‚Üí o tocar/arrastrar para mover la paleta.\nRecoge power-ups:\n- Azul: Paleta grande\n- Naranja: Bolas m√∫ltiples\n- Morado: C√°mara lenta\n- Rojo: L√°ser (pr√≥ximamente)');});

/* ------------------ Inicializar ------------------ */
resizeCanvasToDisplaySize();
window.addEventListener('resize',()=>{resizeCanvasToDisplaySize(); if(running) makeDefaults();});
loop();
</script>
</body>
</html>