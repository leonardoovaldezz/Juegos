<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
    <title>Doodle Jump Original</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        html,body{height:100%}
        body{
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(to top,#87CEEB,#E0F7FA);
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            touch-action: none;
        }
        #gameContainer{
            position:relative;
            max-width:100vw;
            max-height:100vh;
            aspect-ratio: 2/3;
        }
        #gameWrap{
            position:relative;
            width:100%;
            height:100%;
            background:#87CEEB;
            border-radius:8px;
            box-shadow:0 8px 25px rgba(0,0,0,0.3);
            overflow:hidden;
        }
        canvas{
            display:block;
            width:100%;
            height:100%;
            touch-action: none;
        }
        .overlay{
            position:absolute;
            inset:0;
            display:flex;
            align-items:center;
            justify-content:center;
            background:rgba(0,0,0,0.7);
            pointer-events:auto;
            z-index:10;
        }
        .menu{
            width:85%;
            max-width:280px;
            background:white;
            border-radius:12px;
            box-shadow:0 8px 30px rgba(0,0,0,0.3);
            padding:20px;
            text-align:center;
        }
        .menu h1{
            font-size:24px;
            margin-bottom:8px;
            color:#FF6B00;
            text-shadow:1px 1px 2px rgba(0,0,0,0.2);
        }
        .menu p{
            font-size:14px;
            margin:10px 0;
            color:#333;
            line-height:1.4;
        }
        .controls{
            display:flex;
            flex-direction:column;
            gap:8px;
            margin:15px 0;
        }
        .btn{
            background:linear-gradient(to bottom,#FF6B00,#FF8C00);
            color:white;
            padding:12px 20px;
            border-radius:25px;
            cursor:pointer;
            user-select:none;
            font-weight:bold;
            font-size:16px;
            border:none;
            box-shadow:0 4px 8px rgba(255,107,0,0.3);
            transition:all 0.2s;
        }
        .btn:hover{
            transform:translateY(-2px);
            box-shadow:0 6px 12px rgba(255,107,0,0.4);
        }
        .btn.secondary{
            background:linear-gradient(to bottom,#757575,#9E9E9E);
            box-shadow:0 4px 8px rgba(0,0,0,0.2);
        }
        .small{font-size:12px;color:#666;margin-top:10px;line-height:1.3;}
        .hidden{display:none}
        #gameOverPanel{display:none}
        
        /* HUD estilo original */
        .hud {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 5;
            pointer-events: none;
        }
        .score-display, .level-display {
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* Indicadores de power-ups */
        .powerup-display {
            position: absolute;
            top: 50px;
            left: 15px;
            display: flex;
            gap: 6px;
            z-index: 5;
        }
        .powerup-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 2px solid white;
        }
        
        /* Barra de combustible */
        .fuel-bar {
            position: absolute;
            bottom: 10px;
            left: 15px;
            width: 80px;
            height: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
            overflow: hidden;
            border:1px solid rgba(255,255,255,0.3);
        }
        .fuel-fill {
            height: 100%;
            background: linear-gradient(to right, #FF9800, #FF5722);
            border-radius: 3px;
            transition: width 0.1s;
        }

        /* Controles t√°ctiles */
        .touch-controls {
            position: absolute;
            bottom: 20px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 5;
        }
        .touch-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        @media (max-width: 480px) {
            #gameContainer {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
            }
            #gameWrap {
                border-radius: 0;
            }
            .touch-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="gameWrap">
            <canvas id="gameCanvas"></canvas>
            
            <!-- HUD durante el juego -->
            <div class="hud">
                <div class="score-display">Score: <span id="scoreValue">0</span></div>
                <div class="level-display">Level: <span id="levelValue">1</span></div>
            </div>
            
            <!-- Indicadores de power-ups -->
            <div class="powerup-display">
                <div class="powerup-icon" id="jetpackIcon" style="display:none">üöÄ</div>
                <div class="powerup-icon" id="springIcon" style="display:none">üëü</div>
                <div class="powerup-icon" id="shieldIcon" style="display:none">üõ°Ô∏è</div>
                <div class="powerup-icon" id="magnetIcon" style="display:none">üß≤</div>
            </div>
            
            <!-- Barra de combustible -->
            <div class="fuel-bar">
                <div class="fuel-fill" id="fuelFill"></div>
            </div>

            <!-- Controles t√°ctiles -->
            <div class="touch-controls">
                <div class="touch-btn" id="leftBtn">‚Üê</div>
                <div class="touch-btn" id="jetpackBtn">üöÄ</div>
                <div class="touch-btn" id="rightBtn">‚Üí</div>
            </div>

            <!-- Men√∫ Inicio -->
            <div id="startOverlay" class="overlay">
                <div class="menu">
                    <h1>DOODLE JUMP</h1>
                    <p>¬°Salta lo m√°s alto que puedas!</p>
                    <div class="controls">
                        <button id="startBtn" class="btn">JUGAR</button>
                        <button id="tutorialBtn" class="btn secondary">INSTRUCCIONES</button>
                    </div>
                    <div id="tutorial" class="small hidden">
                        <p><strong>Controles:</strong><br>
                        ‚Üê ‚Üí para moverte<br>
                        üöÄ Propulsor (con power-up)</p>
                        <p><strong>¬°Cuidado con los monstruos!</strong><br>
                        Evita los enemigos negros<br>
                        Usa el escudo para protecci√≥n</p>
                        <p><strong>Power-ups:</strong><br>
                        üöÄ Jetpack - Vuela con üöÄ<br>
                        üëü Spring - Salta m√°s alto<br>
                        üõ°Ô∏è Shield - Invencibilidad<br>
                        üß≤ Magnet - Atrae estrellas</p>
                    </div>
                </div>
            </div>

            <!-- Panel Game Over -->
            <div id="gameOverPanel" class="overlay">
                <div class="menu">
                    <h1>GAME OVER</h1>
                    <p id="finalScore">Puntuaci√≥n: 0</p>
                    <p id="highScore">Mejor: 0</p>
                    <p id="newRecord" style="color:#FF6B00;font-weight:bold;display:none;font-size:16px;">¬°NUEVO R√âCORD!</p>
                    <div class="controls">
                        <button id="restartBtn" class="btn">JUGAR DE NUEVO</button>
                        <button id="backMenuBtn" class="btn secondary">MEN√ö</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
// Configuraci√≥n responsive del canvas
function setupCanvas() {
    const container = document.getElementById('gameContainer');
    const canvas = document.getElementById('gameCanvas');
    
    const baseWidth = 320;
    const baseHeight = 480;
    const containerWidth = container.clientWidth;
    const containerHeight = container.clientHeight;
    const aspectRatio = baseWidth / baseHeight;
    let width, height;
    
    if (containerWidth / containerHeight > aspectRatio) {
        height = containerHeight;
        width = height * aspectRatio;
    } else {
        width = containerWidth;
        height = width / aspectRatio;
    }
    
    canvas.width = width;
    canvas.height = height;
    
    return { width, height };
}

/* ================== PAR√ÅMETROS MEJORADOS ================== */
const BASE_GRAVITY = 0.2;
const BASE_JUMP = -9;
const HORIZONTAL_SPEED = 3.5;
const PLATFORM_COUNT = 12;

// Tipos de plataformas MEJORADOS
const PLATFORM_TYPES = {
    NORMAL: 0,
    MOVING: 1,
    BREAKABLE: 2,
    BOUNCY: 3,
    DISAPPEARING: 4,
    TRAMPOLINE: 5
};

// Power-ups MEJORADOS
const POWERUP_TYPES = {
    JETPACK: 0,
    SPRING_SHOES: 1,
    SHIELD: 2,
    MAGNET: 3
};

// Enemigos NUEVOS
const ENEMY_TYPES = {
    MONSTER: 0,
    UFO: 1,
    SPIKES: 2
};

let canvas, ctx;
let width, height;

let state = 'menu';
let player;
let platforms = [];
let stars = [];
let powerups = [];
let enemies = [];
let particles = [];
let score = 0;
let highScore = localStorage.getItem('doodleHighScore') || 0;
let level = 0;
let scrollMultiplier = 1;

let leftPressed = false;
let rightPressed = false;
let spacePressed = false;

// Sistema de power-ups
let jetpackFuel = 100;
let activePowerups = {};
let cameraShake = 0;
let magnetRadius = 0;

// Elementos de UI
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const tutorialBtn = document.getElementById('tutorialBtn');
const tutorial = document.getElementById('tutorial');
const gameOverPanel = document.getElementById('gameOverPanel');
const restartBtn = document.getElementById('restartBtn');
const backMenuBtn = document.getElementById('backMenuBtn');
const finalScoreSpan = document.getElementById('finalScore');
const highScoreSpan = document.getElementById('highScore');
const newRecordSpan = document.getElementById('newRecord');
const scoreValue = document.getElementById('scoreValue');
const levelValue = document.getElementById('levelValue');
const jetpackIcon = document.getElementById('jetpackIcon');
const springIcon = document.getElementById('springIcon');
const shieldIcon = document.getElementById('shieldIcon');
const magnetIcon = document.getElementById('magnetIcon');
const fuelFill = document.getElementById('fuelFill');

// Controles t√°ctiles
const leftBtn = document.getElementById('leftBtn');
const rightBtn = document.getElementById('rightBtn');
const jetpackBtn = document.getElementById('jetpackBtn');

// Variables de optimizaci√≥n
let lastTime = 0;
const FPS = 60;
const frameInterval = 1000 / FPS;

// Array para guardar los timeouts activos
let activeTimeouts = [];

/* --------------- INICIALIZACI√ìN MEJORADA --------------- */
function initGame(){
    const dimensions = setupCanvas();
    canvas = document.getElementById('gameCanvas');
    ctx = canvas.getContext('2d');
    width = dimensions.width;
    height = dimensions.height;
    
    // Reiniciar todas las variables del juego
    player = {
        x: width/2 - 15,
        y: height - 100,
        w: 30,
        h: 40,
        dy: 0,
        gravity: BASE_GRAVITY,
        jumpPower: BASE_JUMP,
        hasShield: false,
        springShoes: false,
        facingRight: true
    };

    score = 0;
    level = 0;
    scrollMultiplier = 1;
    leftPressed = rightPressed = spacePressed = false;
    platforms = [];
    stars = [];
    powerups = [];
    enemies = [];
    particles = [];
    jetpackFuel = 100;
    activePowerups = {};
    cameraShake = 0;
    magnetRadius = 0;

    // Limpiar todos los timeouts activos
    clearAllTimeouts();

    updateHUD();
    updatePowerupIcons();
    updateFuelBar();
    createInitialPlatforms();
    hideGameOver();
}

function clearAllTimeouts() {
    // Limpiar todos los timeouts guardados
    activeTimeouts.forEach(timeoutId => {
        clearTimeout(timeoutId);
    });
    activeTimeouts = [];
    
    // Limpiar timeouts adicionales
    let id = setTimeout(()=>{}, 0);
    while(id--) {
        clearTimeout(id);
    }
}

function createInitialPlatforms(){
    platforms = [];
    
    // SUELO INICIAL S√ìLIDO Y SEGURO - ¬°ESENCIAL!
    platforms.push({ 
        x: 0, 
        y: height - 30, 
        w: width, 
        h: 30, 
        isGround: true,
        type: PLATFORM_TYPES.NORMAL,
        color: '#5D4037',
        moving: 0,
        broken: false,
        active: true
    });
    
    // PRIMERA PLATAFORMA JUSTO ENCIMA DEL JUGADOR - GARANTIZADA
    platforms.push(createPlatform(width/2 - 30, height - 100, PLATFORM_TYPES.NORMAL));
    
    // Crear m√∫ltiples caminos iniciales ASEGURADOS
    createGuaranteedPlatformPath();
}

function createGuaranteedPlatformPath() {
    // Camino principal - GARANTIZADO y ALCANZABLE
    const startY = height - 100;
    const platformHeights = [startY - 80, startY - 160, startY - 240, startY - 320];
    
    platformHeights.forEach((y, index) => {
        // Distribuir plataformas de manera que siempre sean alcanzables
        let x;
        if (index % 2 === 0) {
            x = width * 0.3 + Math.random() * width * 0.2; // Lado izquierdo
        } else {
            x = width * 0.5 + Math.random() * width * 0.2; // Lado derecho
        }
        
        const type = index < 2 ? PLATFORM_TYPES.NORMAL : getPlatformTypeForHeight(y);
        platforms.push(createPlatform(x, y, type));
        
        // A√±adir elementos solo despu√©s de la primera plataforma
        if (index > 0) {
            addPlatformElements(x, y);
        }
    });
    
    // Camino alternativo adicional para m√°s opciones
    const altStartY = height - 120;
    const altPlatformHeights = [altStartY - 70, altStartY - 150, altStartY - 230];
    
    altPlatformHeights.forEach((y, index) => {
        const x = width * 0.7 + Math.random() * width * 0.2;
        platforms.push(createPlatform(x, y, PLATFORM_TYPES.NORMAL));
        
        if (index > 0) {
            addPlatformElements(x, y);
        }
    });
}

function getPlatformTypeForHeight(y) {
    const heightFromBottom = height - y;
    if(heightFromBottom < 300) return PLATFORM_TYPES.NORMAL;
    
    const rand = Math.random();
    if(heightFromBottom < 500) {
        if(rand < 0.7) return PLATFORM_TYPES.NORMAL;
        if(rand < 0.85) return PLATFORM_TYPES.MOVING;
        return PLATFORM_TYPES.BREAKABLE;
    } else {
        if(rand < 0.5) return PLATFORM_TYPES.NORMAL;
        if(rand < 0.7) return PLATFORM_TYPES.MOVING;
        if(rand < 0.85) return PLATFORM_TYPES.BREAKABLE;
        if(rand < 0.95) return PLATFORM_TYPES.DISAPPEARING;
        return PLATFORM_TYPES.TRAMPOLINE;
    }
}

function createPlatform(x, y, type) {
    let color, moving = 0, timer = 0;
    
    switch(type) {
        case PLATFORM_TYPES.NORMAL:
            color = '#4CAF50';
            break;
        case PLATFORM_TYPES.MOVING:
            color = '#2196F3';
            moving = (Math.random() - 0.5) * 3;
            break;
        case PLATFORM_TYPES.BREAKABLE:
            color = '#FF9800';
            break;
        case PLATFORM_TYPES.BOUNCY:
            color = '#9C27B0';
            break;
        case PLATFORM_TYPES.DISAPPEARING:
            color = '#FF5722';
            timer = 100;
            break;
        case PLATFORM_TYPES.TRAMPOLINE:
            color = '#00BCD4';
            break;
    }
    
    return {
        x: x, y: y, w: 60, h: 12,
        isGround: false, type: type, color: color,
        moving: moving, broken: false, timer: timer,
        active: true
    };
}

function addPlatformElements(x, y) {
    // Estrellas
    if(Math.random() < 0.3) {
        stars.push({
            x: x + 22, y: y - 25, w: 16, h: 16,
            collected: false
        });
    }
    
    // Power-ups (m√°s raros)
    if(Math.random() < 0.15) {
        const powerupTypes = Object.values(POWERUP_TYPES);
        const powerupType = powerupTypes[Math.floor(Math.random() * powerupTypes.length)];
        
        powerups.push({
            x: x + 18, y: y - 30, w: 24, h: 24,
            type: powerupType, collected: false
        });
    }
    
    // Enemigos (solo despu√©s de cierta altura y no al inicio)
    if(y < height - 400 && Math.random() < 0.2) {
        const enemyTypes = Object.values(ENEMY_TYPES);
        const enemyType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
        
        enemies.push({
            x: x + 15, y: y - 35, w: 30, h: 30,
            type: enemyType, moving: (Math.random() - 0.5) * 2
        });
    }
}

/* --------------- CONTROLES --------------- */
function setupControls() {
    // Teclado
    document.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowLeft') leftPressed = true;
        if(e.key === 'ArrowRight') rightPressed = true;
        if(e.key === ' ' || e.key === 'Spacebar') spacePressed = true;
    });

    document.addEventListener('keyup', (e) => {
        if(e.key === 'ArrowLeft') leftPressed = false;
        if(e.key === 'ArrowRight') rightPressed = false;
        if(e.key === ' ' || e.key === 'Spacebar') spacePressed = false;
    });

    // Controles t√°ctiles
    const handleTouch = (button, direction, start) => (e) => {
        e.preventDefault();
        if (direction === 'left') leftPressed = start;
        if (direction === 'right') rightPressed = start;
        if (direction === 'jetpack') spacePressed = start;
    };

    leftBtn.addEventListener('touchstart', handleTouch(leftBtn, 'left', true));
    leftBtn.addEventListener('touchend', handleTouch(leftBtn, 'left', false));
    rightBtn.addEventListener('touchstart', handleTouch(rightBtn, 'right', true));
    rightBtn.addEventListener('touchend', handleTouch(rightBtn, 'right', false));
    jetpackBtn.addEventListener('touchstart', handleTouch(jetpackBtn, 'jetpack', true));
    jetpackBtn.addEventListener('touchend', handleTouch(jetpackBtn, 'jetpack', false));

    // Mouse
    leftBtn.addEventListener('mousedown', () => leftPressed = true);
    leftBtn.addEventListener('mouseup', () => leftPressed = false);
    leftBtn.addEventListener('mouseleave', () => leftPressed = false);
    rightBtn.addEventListener('mousedown', () => rightPressed = true);
    rightBtn.addEventListener('mouseup', () => rightPressed = false);
    rightBtn.addEventListener('mouseleave', () => rightPressed = false);
    jetpackBtn.addEventListener('mousedown', () => spacePressed = true);
    jetpackBtn.addEventListener('mouseup', () => spacePressed = false);
    jetpackBtn.addEventListener('mouseleave', () => spacePressed = false);
}

/* --------------- UI --------------- */
function setupUI() {
    startBtn.addEventListener('click', startPlaying);
    tutorialBtn.addEventListener('click', () => tutorial.classList.toggle('hidden'));
    restartBtn.addEventListener('click', startPlaying);
    backMenuBtn.addEventListener('click', () => { 
        state = 'menu';
        initGame(); 
        showStartMenu(); 
    });
}

function updateHUD() {
    scoreValue.textContent = score;
    levelValue.textContent = level + 1;
}

function updatePowerupIcons() {
    jetpackIcon.style.display = activePowerups[POWERUP_TYPES.JETPACK] ? 'flex' : 'none';
    springIcon.style.display = activePowerups[POWERUP_TYPES.SPRING_SHOES] ? 'flex' : 'none';
    shieldIcon.style.display = activePowerups[POWERUP_TYPES.SHIELD] ? 'flex' : 'none';
    magnetIcon.style.display = activePowerups[POWERUP_TYPES.MAGNET] ? 'flex' : 'none';
}

function updateFuelBar() {
    fuelFill.style.width = jetpackFuel + '%';
}

/* --------------- POWER-UPS MEJORADOS --------------- */
function activatePowerup(type) {
    activePowerups[type] = true;
    
    switch(type) {
        case POWERUP_TYPES.JETPACK:
            jetpackFuel = 100;
            updateFuelBar();
            const jetpackTimeout = setTimeout(() => {
                delete activePowerups[type];
                updatePowerupIcons();
            }, 15000);
            activeTimeouts.push(jetpackTimeout);
            break;
            
        case POWERUP_TYPES.SPRING_SHOES:
            player.springShoes = true;
            const springTimeout = setTimeout(() => {
                player.springShoes = false;
                delete activePowerups[type];
                updatePowerupIcons();
            }, 10000);
            activeTimeouts.push(springTimeout);
            break;
            
        case POWERUP_TYPES.SHIELD:
            player.hasShield = true;
            const shieldTimeout = setTimeout(() => {
                player.hasShield = false;
                delete activePowerups[type];
                updatePowerupIcons();
            }, 8000);
            activeTimeouts.push(shieldTimeout);
            break;
            
        case POWERUP_TYPES.MAGNET:
            magnetRadius = 120;
            const magnetTimeout = setTimeout(() => {
                magnetRadius = 0;
                delete activePowerups[type];
                updatePowerupIcons();
            }, 10000);
            activeTimeouts.push(magnetTimeout);
            break;
    }
    
    updatePowerupIcons();
}

/* --------------- DIBUJADO MEJORADO --------------- */
function clearCanvas() {
    ctx.fillStyle = '#87CEEB';
    ctx.fillRect(0, 0, width, height);
}

function drawPlayer(){
    // Direcci√≥n del personaje
    if(leftPressed && !rightPressed) player.facingRight = false;
    if(rightPressed && !leftPressed) player.facingRight = true;
    
    // Escudo visual
    if(player.hasShield) {
        ctx.strokeStyle = '#00E5FF';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(player.x + player.w/2, player.y + player.h/2, player.w/2 + 5, 0, Math.PI * 2);
        ctx.stroke();
    }
    
    // Cuerpo del jugador
    ctx.fillStyle = '#FF6B00';
    ctx.fillRect(player.x, player.y, player.w, player.h);
    
    // Ojos (dependiendo de la direcci√≥n)
    ctx.fillStyle = 'white';
    if(player.facingRight) {
        ctx.fillRect(player.x + 18, player.y + 8, 6, 6);
        ctx.fillRect(player.x + 8, player.y + 8, 4, 4);
    } else {
        ctx.fillRect(player.x + 6, player.y + 8, 6, 6);
        ctx.fillRect(player.x + 18, player.y + 8, 4, 4);
    }
    
    ctx.fillStyle = 'black';
    if(player.facingRight) {
        ctx.fillRect(player.x + 20, player.y + 10, 2, 2);
        ctx.fillRect(player.x + 10, player.y + 10, 2, 2);
    } else {
        ctx.fillRect(player.x + 8, player.y + 10, 2, 2);
        ctx.fillRect(player.x + 18, player.y + 10, 2, 2);
    }
    
    // Boca
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 1;
    ctx.beginPath();
    if(player.dy < -2) {
        // Sonriendo cuando sube
        ctx.arc(player.x + 15, player.y + 22, 5, 0.2, Math.PI - 0.2, false);
    } else if(player.dy > 2) {
        // Asustado cuando cae r√°pido
        ctx.arc(player.x + 15, player.y + 24, 4, Math.PI + 0.2, Math.PI * 2 - 0.2, false);
    } else {
        // Normal
        ctx.moveTo(player.x + 10, player.y + 22);
        ctx.lineTo(player.x + 20, player.y + 22);
    }
    ctx.stroke();
    
    // Propulsor
    if(spacePressed && jetpackFuel > 0 && activePowerups[POWERUP_TYPES.JETPACK]) {
        ctx.fillStyle = '#FF5722';
        for(let i = 0; i < 3; i++) {
            ctx.fillRect(
                player.x + player.w/2 - 3 + (Math.random() - 0.5) * 4,
                player.y + player.h + Math.random() * 6,
                2 + Math.random() * 2,
                6 + Math.random() * 4
            );
        }
    }
}

function drawPlatforms(){
    platforms.forEach(p => {
        if(p.broken || !p.active) return;
        
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, p.w, p.h);
        
        // Patrones especiales para plataformas
        if(p.type === PLATFORM_TYPES.DISAPPEARING) {
            // Efecto parpadeante para plataformas que desaparecen
            const blink = Math.sin(Date.now() * 0.01) > 0;
            if(blink) {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(p.x + 2, p.y + 2, p.w - 4, p.h - 4);
            }
        } else if(p.type === PLATFORM_TYPES.TRAMPOLINE) {
            // Resorte en plataformas trampol√≠n
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let i = 0; i < 3; i++) {
                const x1 = p.x + 10 + i * 15;
                const x2 = x1 + 10;
                ctx.moveTo(x1, p.y + 3);
                ctx.lineTo(x2, p.y + p.h - 3);
            }
            ctx.stroke();
        }
    });
}

function drawStars() {
    ctx.fillStyle = '#FFD700';
    stars.forEach(star => {
        if (!star.collected) {
            ctx.beginPath();
            ctx.arc(star.x + star.w/2, star.y + star.h/2, star.w/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Brillo
            ctx.strokeStyle = '#FFF9C4';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
    });
}

function drawPowerups() {
    powerups.forEach(powerup => {
        if (!powerup.collected) {
            let color, symbol;
            switch(powerup.type) {
                case POWERUP_TYPES.JETPACK:
                    color = '#FF4081';
                    symbol = 'üöÄ';
                    break;
                case POWERUP_TYPES.SPRING_SHOES:
                    color = '#FFD740';
                    symbol = 'üëü';
                    break;
                case POWERUP_TYPES.SHIELD:
                    color = '#40C4FF';
                    symbol = 'üõ°Ô∏è';
                    break;
                case POWERUP_TYPES.MAGNET:
                    color = '#E040FB';
                    symbol = 'üß≤';
                    break;
            }
            
            ctx.fillStyle = color;
            ctx.fillRect(powerup.x, powerup.y, powerup.w, powerup.h);
            
            ctx.fillStyle = '#FFF';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol, powerup.x + powerup.w/2, powerup.y + powerup.h/2);
        }
    });
}

function drawEnemies() {
    enemies.forEach(enemy => {
        switch(enemy.type) {
            case ENEMY_TYPES.MONSTER:
                // Monstruo simple
                ctx.fillStyle = '#333';
                ctx.fillRect(enemy.x, enemy.y, enemy.w, enemy.h);
                
                // Ojos rojos
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(enemy.x + 8, enemy.y + 8, 4, 4);
                ctx.fillRect(enemy.x + 18, enemy.y + 8, 4, 4);
                break;
                
            case ENEMY_TYPES.UFO:
                // OVNI
                ctx.fillStyle = '#666';
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.w/2, enemy.y + enemy.h/2, enemy.w/2, 0, Math.PI * 2);
                ctx.fill();
                
                // C√∫pula
                ctx.fillStyle = '#888';
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.w/2, enemy.y + enemy.h/2 - 3, enemy.w/3, 0, Math.PI * 2);
                ctx.fill();
                break;
                
            case ENEMY_TYPES.SPIKES:
                // Pinchos
                ctx.fillStyle = '#FF0000';
                for(let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(enemy.x + i * 10, enemy.y + enemy.h);
                    ctx.lineTo(enemy.x + 5 + i * 10, enemy.y);
                    ctx.lineTo(enemy.x + 10 + i * 10, enemy.y + enemy.h);
                    ctx.closePath();
                    ctx.fill();
                }
                break;
        }
    });
}

/* --------------- L√ìGICA DEL JUEGO MEJORADA --------------- */
function updateGameLogic() {
    // Movimiento lateral
    if(leftPressed) player.x -= HORIZONTAL_SPEED;
    if(rightPressed) player.x += HORIZONTAL_SPEED;
    
    // Wrap-around
    if(player.x + player.w < 0) player.x = width;
    if(player.x > width) player.x = -player.w;

    // Propulsor
    if(spacePressed && jetpackFuel > 0 && activePowerups[POWERUP_TYPES.JETPACK]) {
        player.dy = -8;
        jetpackFuel -= 0.8;
        updateFuelBar();
    }

    // F√≠sica vertical
    player.y += player.dy;
    player.dy += player.gravity;

    // Actualizar elementos del juego
    updatePlatforms();
    updateEnemies();
    handleCollisions();
    handleCameraScroll();
    recycleElements();

    // Recargar combustible
    if(jetpackFuel < 100 && !spacePressed) {
        jetpackFuel += 0.2;
        updateFuelBar();
    }

    // Game Over
    if(player.y > height){
        endGame();
        return false;
    }
    
    return true;
}

function updatePlatforms() {
    platforms.forEach(p => {
        // Plataformas m√≥viles
        if(p.moving !== 0 && !p.isGround) {
            p.x += p.moving;
            if(p.x < 0 || p.x + p.w > width) {
                p.moving *= -1;
            }
        }
        
        // Plataformas que desaparecen
        if(p.type === PLATFORM_TYPES.DISAPPEARING && p.active) {
            p.timer--;
            if(p.timer <= 0) {
                p.active = false;
            }
        }
    });
}

function updateEnemies() {
    enemies.forEach(enemy => {
        if(enemy.moving !== 0) {
            enemy.x += enemy.moving;
            if(enemy.x < 0 || enemy.x + enemy.w > width) {
                enemy.moving *= -1;
            }
        }
    });
}

function handleCollisions() {
    // Colisi√≥n con plataformas
    let landed = false;
    for(let i = 0; i < platforms.length; i++){
        const p = platforms[i];
        if(p.broken || !p.active) continue;
        
        if(player.x + player.w > p.x && player.x < p.x + p.w &&
           player.y + player.h >= p.y && player.y + player.h <= p.y + 10 &&
           player.dy > 0) {
             
            let jumpForce = player.jumpPower;
            
            // Efectos especiales de plataformas
            switch(p.type) {
                case PLATFORM_TYPES.BREAKABLE:
                    p.broken = true;
                    break;
                case PLATFORM_TYPES.BOUNCY:
                    jumpForce *= 1.4;
                    break;
                case PLATFORM_TYPES.TRAMPOLINE:
                    jumpForce *= 1.8;
                    break;
                case PLATFORM_TYPES.DISAPPEARING:
                    p.active = false;
                    break;
            }
            
            // Bonus de zapatos de resorte
            if(player.springShoes) jumpForce *= 1.3;
            
            player.dy = jumpForce;
            player.y = p.y - player.h;
            landed = true;
            break;
        }
    }

    // Colisi√≥n con estrellas (con im√°n)
    for(let i = 0; i < stars.length; i++){
        const star = stars[i];
        if(!star.collected) {
            // Efecto im√°n
            if(magnetRadius > 0) {
                const dx = (player.x + player.w/2) - (star.x + star.w/2);
                const dy = (player.y + player.h/2) - (star.y + star.h/2);
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if(distance < magnetRadius) {
                    star.x += dx * 0.1;
                    star.y += dy * 0.1;
                }
            }
            
            if(player.x < star.x + star.w && player.x + player.w > star.x &&
               player.y < star.y + star.h && player.y + player.h > star.y){
              
                star.collected = true;
                score += 5;
                updateHUD();
            }
        }
    }

    // Colisi√≥n con power-ups
    for(let i = 0; i < powerups.length; i++){
        const powerup = powerups[i];
        if(!powerup.collected &&
           player.x < powerup.x + powerup.w && player.x + player.w > powerup.x &&
           player.y < powerup.y + powerup.h && player.y + player.h > powerup.y){
          
            powerup.collected = true;
            activatePowerup(powerup.type);
        }
    }

    // Colisi√≥n con enemigos (solo si no tiene escudo)
    if(!player.hasShield) {
        for(let i = 0; i < enemies.length; i++){
            const enemy = enemies[i];
            if(player.x < enemy.x + enemy.w && player.x + player.w > enemy.x &&
               player.y < enemy.y + enemy.h && player.y + player.h > enemy.y){
              
                endGame();
                return false;
            }
        }
    }
}

function handleCameraScroll() {
    if(player.y < height / 3){
        const offset = (height / 3 - player.y) * scrollMultiplier;
        player.y = height / 3;
        platforms.forEach(p => p.y += offset);
        stars.forEach(star => star.y += offset);
        powerups.forEach(powerup => powerup.y += offset);
        enemies.forEach(enemy => enemy.y += offset);
    }
}

function recycleElements() {
    let minY = Infinity;
    platforms.forEach(p => {
        if(!p.isGround && p.y < minY) minY = p.y;
    });

    // Reciclar plataformas
    for(let i = platforms.length - 1; i >= 0; i--){
        const p = platforms[i];
        if(p.y > height && !p.isGround){
            const gap = 60 + Math.random() * 40;
            p.y = minY - gap;
            p.x = Math.random() * (width - p.w);
            p.broken = false;
            p.active = true;
            
            // Cambiar tipo de plataforma seg√∫n la altura
            const heightFromBottom = height - p.y;
            p.type = getPlatformTypeForHeight(p.y);
            p.color = getPlatformColor(p.type);
            
            minY = p.y;
            score++;
            
            // Actualizar nivel y dificultad
            const newLevel = Math.floor(score / 20);
            if(newLevel !== level){
                level = newLevel;
                scrollMultiplier = 1 + level * 0.03;
                updateHUD();
            }
            
            // Ocasionalmente a√±adir elementos
            if(Math.random() < 0.4) {
                addPlatformElements(p.x, p.y);
            }
        }
    }
    
    // Limpiar elementos
    stars = stars.filter(star => !star.collected && star.y <= height);
    powerups = powerups.filter(powerup => !powerup.collected && powerup.y <= height);
    enemies = enemies.filter(enemy => enemy.y <= height);
}

function getPlatformColor(type) {
    switch(type) {
        case PLATFORM_TYPES.NORMAL: return '#4CAF50';
        case PLATFORM_TYPES.MOVING: return '#2196F3';
        case PLATFORM_TYPES.BREAKABLE: return '#FF9800';
        case PLATFORM_TYPES.BOUNCY: return '#9C27B0';
        case PLATFORM_TYPES.DISAPPEARING: return '#FF5722';
        case PLATFORM_TYPES.TRAMPOLINE: return '#00BCD4';
        default: return '#4CAF50';
    }
}

/* --------------- BUCLE PRINCIPAL --------------- */
function gameLoop(timestamp) {
    if (!lastTime) lastTime = timestamp;
    const deltaTime = timestamp - lastTime;
    
    if (deltaTime > frameInterval) {
        clearCanvas();
        drawPlatforms();
        drawStars();
        drawPowerups();
        drawEnemies();
        drawPlayer();
        
        if(state === 'playing') {
            const continuePlaying = updateGameLogic();
            if (!continuePlaying) {
                // Si el juego termin√≥, seguimos el bucle pero sin actualizar la l√≥gica
                lastTime = timestamp - (deltaTime % frameInterval);
                requestAnimationFrame(gameLoop);
                return;
            }
        }
        
        lastTime = timestamp - (deltaTime % frameInterval);
    }
    
    requestAnimationFrame(gameLoop);
}

/* --------------- INICIO / FIN --------------- */
function startPlaying(){
    hideStartMenu();
    hideGameOver();
    initGame(); // Reinicio completo
    player.dy = -5; // Impulso inicial garantizado
    state = 'playing';
    lastTime = 0;
    // Asegurarse de que el bucle del juego contin√∫e
    requestAnimationFrame(gameLoop);
}

function endGame(){
    state = 'gameover';
    newRecordSpan.style.display = 'none';
    
    if(score > highScore) {
        highScore = score;
        localStorage.setItem('doodleHighScore', highScore);
        newRecordSpan.style.display = 'block';
    }
    
    finalScoreSpan.textContent = 'Puntuaci√≥n: ' + score;
    highScoreSpan.textContent = 'Mejor: ' + highScore;
    showGameOver();
}

/* --------------- UI HELPERS --------------- */
function showStartMenu(){ 
    startOverlay.style.display = 'flex'; 
    state = 'menu';
}
function hideStartMenu(){ 
    startOverlay.style.display = 'none'; 
}
function showGameOver(){ 
    gameOverPanel.style.display = 'flex'; 
    state = 'gameover';
}
function hideGameOver(){ 
    gameOverPanel.style.display = 'none'; 
}

// Inicializaci√≥n
window.addEventListener('load', () => {
    initGame();
    setupControls();
    setupUI();
    showStartMenu();
    requestAnimationFrame(gameLoop);
});

window.addEventListener('resize', () => {
    if (state === 'menu') {
        initGame();
    }
});
</script>
</body>
</html>